<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathfinder 2E Kingdom Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'fantasy': ['Cinzel', 'serif'],
                        'body': ['Inter', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'float': 'float 3s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                        'gradient': 'gradient 3s ease infinite',
                    },
                    backgroundImage: {
                        'magical': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        'royal': 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)',
                        'gold': 'linear-gradient(135deg, #f7971e 0%, #ffd200 100%)',
                        'emerald': 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                        'ruby': 'linear-gradient(135deg, #fc466b 0%, #3f5efb 100%)',
                        'ancient': 'linear-gradient(135deg, #8360c3 0%, #2ebf91 100%)'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
            to { box-shadow: 0 0 30px rgba(59, 130, 246, 0.8); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        .magical-border {
            background: linear-gradient(45deg, #667eea, #764ba2, #667eea);
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
            padding: 2px;
            border-radius: 1rem;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .skill-orb {
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), transparent 70%);
            border: 3px solid rgba(255,255,255,0.3);
            box-shadow: 
                inset 0 0 20px rgba(255,255,255,0.2),
                0 8px 32px rgba(0,0,0,0.3);
        }
        .ruin-crystal {
            background: linear-gradient(145deg, #ff6b6b, #ee5a24);
            position: relative;
            overflow: hidden;
        }
        .ruin-crystal::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        .phase-orb {
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.8), rgba(29, 78, 216, 0.9));
            box-shadow: 
                0 0 30px rgba(59, 130, 246, 0.6),
                inset 0 0 20px rgba(255, 255, 255, 0.3);
        }
        .phase-orb.completed {
            background: radial-gradient(circle at center, rgba(16, 185, 129, 0.8), rgba(5, 150, 105, 0.9));
            box-shadow: 
                0 0 30px rgba(16, 185, 129, 0.6),
                inset 0 0 20px rgba(255, 255, 255, 0.3);
        }
        .resource-gem {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            border-radius: 50%;
            position: relative;
            overflow: hidden;
        }
        .resource-gem::after {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 30%;
            height: 30%;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            filter: blur(4px);
        }
        body {
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        .kingdom-crest {
            background: radial-gradient(circle, #ffd700, #ff8c00);
            animation: float 3s ease-in-out infinite;
        }
        .stat-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body class="text-white">
    <!-- Header with Kingdom Identity -->
    <header class="relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-blue-900/20 via-purple-900/20 to-blue-900/20"></div>
        <div class="relative z-10 max-w-7xl mx-auto px-6 py-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <div class="kingdom-crest w-20 h-20 rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-2xl">
                        ‚öîÔ∏è
                    </div>
                    <div>
                        <h1 class="font-fantasy text-4xl font-bold bg-gradient-to-r from-yellow-400 to-orange-400 bg-clip-text text-transparent" id="kingdomName">
                            Nauthgard
                        </h1>
                        <p class="text-blue-200 text-lg">Capital: <span id="kingdomCapital" class="text-yellow-300 font-medium">Lakewatch</span></p>
                        <p class="text-gray-300 text-sm italic">"Per Profectum Surgimus"</p>
                    </div>
                </div>
                <div class="text-right space-y-3">
                    <div class="bg-gradient-to-r from-purple-500 to-blue-500 px-6 py-3 rounded-xl text-center">
                        <div class="text-2xl font-bold">Level <span id="kingdomLevel">3</span></div>
                        <div class="text-sm opacity-80">Size <span id="kingdomSize">12</span> ‚Ä¢ Province</div>
                    </div>
                    <button onclick="toggleCloudPanel()" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 px-4 py-2 rounded-lg text-sm font-medium transition-all">
                        ‚òÅÔ∏è Cloud Sync
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Cloud Storage Panel -->
    <div id="cloudPanel" class="hidden bg-gradient-to-r from-cyan-900/40 to-blue-900/40 backdrop-blur-xl border-b border-cyan-400/30">
        <div class="max-w-7xl mx-auto px-6 py-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Save to Cloud -->
                <div class="glass-morphism rounded-xl p-6">
                    <h3 class="font-fantasy text-xl font-bold mb-4 text-cyan-400">‚òÅÔ∏è Save to Cloud</h3>
                    <p class="text-gray-300 text-sm mb-4">Share your kingdom with other players. Anyone with the Kingdom ID can view and edit.</p>
                    <div class="space-y-3">
                        <button onclick="saveToCloud()" id="saveCloudBtn" class="w-full bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-400 hover:to-green-500 text-white px-6 py-3 rounded-xl font-bold transition-all">
                            üíæ Save to Cloud
                        </button>
                        <div id="cloudSaveResult" class="hidden">
                            <div class="bg-green-900/30 border border-green-400/30 rounded-lg p-4">
                                <p class="text-green-300 font-medium mb-2">‚úÖ Kingdom saved to cloud!</p>
                                <div class="flex gap-2">
                                    <input type="text" id="cloudId" readonly class="flex-1 bg-gray-800 text-white px-3 py-2 rounded font-mono text-sm" value="">
                                    <button onclick="copyCloudId()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded font-medium">
                                        üìã Copy
                                    </button>
                                </div>
                                <p class="text-cyan-300 text-xs mt-2">Share this ID with your party members!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Load from Cloud -->
                <div class="glass-morphism rounded-xl p-6">
                    <h3 class="font-fantasy text-xl font-bold mb-4 text-blue-400">üîó Load from Cloud</h3>
                    <p class="text-gray-300 text-sm mb-4">Enter a Kingdom ID to load a shared kingdom.</p>
                    <div class="space-y-3">
                        <input type="text" id="loadCloudId" placeholder="Enter Kingdom ID (e.g., abc123...)" class="w-full bg-gray-800 text-white px-4 py-3 rounded-xl border border-gray-600 focus:border-blue-400 focus:outline-none">
                        <button onclick="loadFromCloud()" id="loadCloudBtn" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-400 hover:to-indigo-500 text-white px-6 py-3 rounded-xl font-bold transition-all">
                            üì• Load from Cloud
                        </button>
                        <div class="flex items-center gap-3 bg-purple-900/30 border border-purple-400/30 rounded-lg p-3">
                            <input type="checkbox" id="autoSyncCheckbox" onchange="toggleAutoSync()" class="w-5 h-5 rounded">
                            <label for="autoSyncCheckbox" class="text-purple-300 text-sm cursor-pointer">
                                Auto-sync changes to cloud (collaborative mode)
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div id="cloudStatus" class="mt-4 text-center text-sm text-gray-400"></div>

            <!-- API Key Settings -->
            <div class="mt-6 glass-morphism rounded-xl p-4">
                <details class="cursor-pointer">
                    <summary class="text-sm text-gray-300 font-medium">‚öôÔ∏è Advanced Settings (Optional API Key)</summary>
                    <div class="mt-4 space-y-3">
                        <p class="text-xs text-gray-400">
                            The app includes a demo API key with limitations. For better reliability and privacy,
                            <a href="https://jsonbin.io/" target="_blank" class="text-cyan-400 hover:text-cyan-300 underline">get your own free API key</a>
                            from JSONBin.io (takes 30 seconds, no credit card required).
                        </p>
                        <div class="flex gap-2">
                            <input type="text" id="customApiKey" placeholder="Paste your API key here (optional)"
                                   class="flex-1 bg-gray-800 text-white px-3 py-2 rounded text-sm border border-gray-600 focus:border-cyan-400 focus:outline-none"
                                   value="">
                            <button onclick="saveApiKey()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded font-medium text-sm">
                                Save Key
                            </button>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-black/40 backdrop-blur-xl border-b border-white/10">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex space-x-1">
                <button onclick="showTab('overview')" class="tab-btn px-6 py-4 text-blue-400 border-b-2 border-blue-400 font-medium transition-all hover:bg-white/5">
                    üè∞ Overview
                </button>
                <button onclick="showTab('turns')" class="tab-btn px-6 py-4 text-gray-400 border-b-2 border-transparent font-medium transition-all hover:bg-white/5 hover:text-white">
                    üìÖ Turn Tracker
                </button>
                <button onclick="showTab('settlements')" class="tab-btn px-6 py-4 text-gray-400 border-b-2 border-transparent font-medium transition-all hover:bg-white/5 hover:text-white">
                    üèòÔ∏è Settlements
                </button>
                <button onclick="showTab('structures')" class="tab-btn px-6 py-4 text-gray-400 border-b-2 border-transparent font-medium transition-all hover:bg-white/5 hover:text-white">
                    üèóÔ∏è Structures
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6 space-y-8">
        <!-- Kingdom Overview Tab -->
        <div id="overview" class="tab-content active space-y-8">
            <!-- Ability Scores as Magical Orbs -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="card-hover">
                    <div class="magical-border">
                        <div class="bg-gradient-to-br from-purple-600 to-blue-700 rounded-xl p-8 text-center relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
                            <div class="relative z-10">
                                <div class="skill-orb w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center">
                                    <span class="text-3xl">üìö</span>
                                </div>
                                <h3 class="font-fantasy text-xl font-bold mb-2">Culture</h3>
                                <div class="text-4xl font-bold mb-2" id="culture">12</div>
                                <div class="text-sm opacity-80">Modifier: <span id="culturemod" class="text-yellow-300 font-bold">+1</span></div>
                                <button onclick="editStat('culture')" class="mt-3 text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full transition-all">
                                    Edit
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-hover">
                    <div class="magical-border">
                        <div class="bg-gradient-to-br from-emerald-600 to-green-700 rounded-xl p-8 text-center relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
                            <div class="relative z-10">
                                <div class="skill-orb w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center">
                                    <span class="text-3xl">üí∞</span>
                                </div>
                                <h3 class="font-fantasy text-xl font-bold mb-2">Economy</h3>
                                <div class="text-4xl font-bold mb-2" id="economy">14</div>
                                <div class="text-sm opacity-80">Modifier: <span id="economymod" class="text-yellow-300 font-bold">+2</span></div>
                                <button onclick="editStat('economy')" class="mt-3 text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full transition-all">
                                    Edit
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-hover">
                    <div class="magical-border">
                        <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl p-8 text-center relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
                            <div class="relative z-10">
                                <div class="skill-orb w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center">
                                    <span class="text-3xl">üëë</span>
                                </div>
                                <h3 class="font-fantasy text-xl font-bold mb-2">Loyalty</h3>
                                <div class="text-4xl font-bold mb-2" id="loyalty">14</div>
                                <div class="text-sm opacity-80">Modifier: <span id="loyaltymod" class="text-yellow-300 font-bold">+2</span></div>
                                <button onclick="editStat('loyalty')" class="mt-3 text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full transition-all">
                                    Edit
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-hover">
                    <div class="magical-border">
                        <div class="bg-gradient-to-br from-red-600 to-pink-700 rounded-xl p-8 text-center relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
                            <div class="relative z-10">
                                <div class="skill-orb w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center">
                                    <span class="text-3xl">üõ°Ô∏è</span>
                                </div>
                                <h3 class="font-fantasy text-xl font-bold mb-2">Stability</h3>
                                <div class="text-4xl font-bold mb-2" id="stability">14</div>
                                <div class="text-sm opacity-80">Modifier: <span id="stabilitymod" class="text-yellow-300 font-bold">+2</span></div>
                                <button onclick="editStat('stability')" class="mt-3 text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full transition-all">
                                    Edit
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress and Resources -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Progress Panel -->
                <div class="glass-morphism rounded-2xl p-8 card-hover">
                    <h3 class="font-fantasy text-2xl font-bold mb-6 bg-gradient-to-r from-yellow-400 to-orange-400 bg-clip-text text-transparent">
                        ‚≠ê Kingdom Progress
                    </h3>
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-lg font-medium">Experience Points</span>
                                <span class="text-xl font-bold"><span id="currentXP" class="text-blue-400">186</span> / 1000</span>
                            </div>
                            <div class="w-full bg-gray-800 rounded-full h-4 overflow-hidden">
                                <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-4 rounded-full transition-all duration-500 shadow-lg" id="xpBar" style="width: 18.6%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-6">
                            <div class="bg-yellow-500/20 rounded-xl p-4 text-center">
                                <div class="text-3xl mb-2">üèÜ</div>
                                <div class="text-sm text-gray-300">Fame</div>
                                <div class="text-2xl font-bold text-yellow-400" id="fame">0</div>
                            </div>
                            <div class="bg-red-500/20 rounded-xl p-4 text-center">
                                <div class="text-3xl mb-2">üéØ</div>
                                <div class="text-sm text-gray-300">Control DC</div>
                                <div class="text-2xl font-bold text-red-400" id="controlDC">17</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resources Panel -->
                <div class="glass-morphism rounded-2xl p-8 card-hover">
                    <h3 class="font-fantasy text-2xl font-bold mb-6 bg-gradient-to-r from-emerald-400 to-blue-400 bg-clip-text text-transparent">
                        üíé Royal Treasury
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gradient-to-br from-yellow-600/30 to-orange-600/30 rounded-xl p-4 text-center">
                            <div class="resource-gem w-12 h-12 mx-auto mb-3">
                                <div class="w-full h-full rounded-full flex items-center justify-center text-xl">üåæ</div>
                            </div>
                            <div class="text-sm text-gray-300">Food</div>
                            <div class="text-xl font-bold" id="food">1</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-600/30 to-emerald-600/30 rounded-xl p-4 text-center">
                            <div class="resource-gem w-12 h-12 mx-auto mb-3">
                                <div class="w-full h-full rounded-full flex items-center justify-center text-xl">üå≤</div>
                            </div>
                            <div class="text-sm text-gray-300">Lumber</div>
                            <div class="text-xl font-bold" id="lumber">1</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-600/30 to-pink-600/30 rounded-xl p-4 text-center">
                            <div class="resource-gem w-12 h-12 mx-auto mb-3">
                                <div class="w-full h-full rounded-full flex items-center justify-center text-xl">üíé</div>
                            </div>
                            <div class="text-sm text-gray-300">Luxuries</div>
                            <div class="text-xl font-bold" id="luxuries">3</div>
                        </div>
                        <div class="bg-gradient-to-br from-gray-600/30 to-slate-600/30 rounded-xl p-4 text-center">
                            <div class="resource-gem w-12 h-12 mx-auto mb-3">
                                <div class="w-full h-full rounded-full flex items-center justify-center text-xl">‚õèÔ∏è</div>
                            </div>
                            <div class="text-sm text-gray-300">Ore</div>
                            <div class="text-xl font-bold" id="ore">2</div>
                        </div>
                        <div class="bg-gradient-to-br from-slate-600/30 to-gray-600/30 rounded-xl p-4 text-center">
                            <div class="resource-gem w-12 h-12 mx-auto mb-3">
                                <div class="w-full h-full rounded-full flex items-center justify-center text-xl">üóø</div>
                            </div>
                            <div class="text-sm text-gray-300">Stone</div>
                            <div class="text-xl font-bold" id="stone">1</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ruin Crystals -->
            <div class="glass-morphism rounded-2xl p-8 card-hover">
                <h3 class="font-fantasy text-2xl font-bold mb-6 bg-gradient-to-r from-red-400 to-pink-400 bg-clip-text text-transparent">
                    ‚ò†Ô∏è Ruin Crystals
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="ruin-crystal w-16 h-16 mx-auto mb-3 rounded-lg flex items-center justify-center">
                            <span class="text-2xl relative z-10">üñ§</span>
                        </div>
                        <div class="text-sm text-gray-300">Corruption</div>
                        <div class="text-xl font-bold" id="corruption">0</div>
                    </div>
                    <div class="text-center">
                        <div class="ruin-crystal w-16 h-16 mx-auto mb-3 rounded-lg flex items-center justify-center">
                            <span class="text-2xl relative z-10">üó°Ô∏è</span>
                        </div>
                        <div class="text-sm text-gray-300">Crime</div>
                        <div class="text-xl font-bold" id="crime">2</div>
                    </div>
                    <div class="text-center">
                        <div class="ruin-crystal w-16 h-16 mx-auto mb-3 rounded-lg flex items-center justify-center">
                            <span class="text-2xl relative z-10">üíÄ</span>
                        </div>
                        <div class="text-sm text-gray-300">Decay</div>
                        <div class="text-xl font-bold" id="decay">0</div>
                    </div>
                    <div class="text-center">
                        <div class="ruin-crystal w-16 h-16 mx-auto mb-3 rounded-lg flex items-center justify-center">
                            <span class="text-2xl relative z-10">‚ö°</span>
                        </div>
                        <div class="text-sm text-gray-300">Strife</div>
                        <div class="text-xl font-bold" id="strife">1</div>
                    </div>
                </div>
            </div>

            <!-- Level Up Alert -->
            <div id="levelUpAlert" class="glass-morphism rounded-2xl p-8 bg-gradient-to-r from-yellow-600/20 to-orange-600/20 border-yellow-400/30 animate-glow" style="display: none;">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-fantasy text-3xl font-bold mb-2 text-yellow-400">üéâ Ascension Available!</h4>
                        <p class="text-xl text-yellow-200">Your kingdom has accumulated enough experience to ascend to the next level of power</p>
                    </div>
                    <button onclick="levelUp()" class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 text-black px-8 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-2xl">
                        ‚ö° ASCEND ‚ö°
                    </button>
                </div>
            </div>
        </div>

        <!-- Turn Tracker Tab -->
        <div id="turns" class="tab-content space-y-8">
            <div class="glass-morphism rounded-2xl p-8">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="font-fantasy text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                            üìÖ Turn: <span id="currentMonth">Lamashan</span> <span id="currentYear">4708</span>
                        </h2>
                        <div class="mt-3 grid grid-cols-2 gap-4 max-w-md">
                            <div class="text-sm">
                                <span class="text-gray-400">Unrest:</span>
                                <span class="text-yellow-400 font-bold ml-2" id="unrestDisplay">0</span>
                                <span class="text-red-400 ml-1" id="unrestPenaltyDisplay"></span>
                            </div>
                            <div class="text-sm">
                                <span class="text-gray-400">Resource Points:</span>
                                <span class="text-cyan-400 font-bold ml-2" id="rpDisplay">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <span class="text-gray-300 font-medium block mb-2">Current Phase:</span>
                            <div class="bg-gradient-to-r from-blue-500 to-purple-600 px-6 py-3 rounded-full font-bold" id="currentPhase">Upkeep</div>
                        </div>
                    </div>
                </div>

                <!-- Phase Progress as Magical Orbs -->
                <div class="flex items-center justify-between mb-12 px-8">
                    <div class="flex flex-col items-center">
                        <div class="phase-orb w-16 h-16 rounded-full text-white flex items-center justify-center text-xl font-bold mb-3">1</div>
                        <span class="text-lg font-bold text-blue-400">Upkeep</span>
                    </div>
                    <div class="flex-1 h-1 bg-gradient-to-r from-blue-500 to-gray-600 mx-6 rounded-full"></div>
                    <div class="flex flex-col items-center">
                        <div class="phase-orb w-16 h-16 rounded-full bg-gray-600 text-gray-400 flex items-center justify-center text-xl font-bold mb-3">2</div>
                        <span class="text-lg font-medium text-gray-400">Activity</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-600 mx-6 rounded-full"></div>
                    <div class="flex flex-col items-center">
                        <div class="phase-orb w-16 h-16 rounded-full bg-gray-600 text-gray-400 flex items-center justify-center text-xl font-bold mb-3">3</div>
                        <span class="text-lg font-medium text-gray-400">Event</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-600 mx-6 rounded-full"></div>
                    <div class="flex flex-col items-center">
                        <div class="phase-orb w-16 h-16 rounded-full bg-gray-600 text-gray-400 flex items-center justify-center text-xl font-bold mb-3">4</div>
                        <span class="text-lg font-medium text-gray-400">Commerce</span>
                    </div>
                </div>

                <!-- Phase-Specific Content -->
                <div id="phaseContent" class="space-y-6">
                    <!-- Upkeep Phase -->
                    <div id="upkeepPhaseContent" class="space-y-6">
                        <div class="bg-gradient-to-r from-blue-600/20 to-indigo-600/20 border border-blue-400/30 rounded-2xl p-8">
                            <h4 class="font-fantasy text-2xl font-bold text-blue-400 mb-4">üìú Upkeep Phase</h4>
                            <ul class="space-y-2 text-gray-300">
                                <li>‚úÖ Step 1: Gain Fame (+1 Fame/Infamy)</li>
                                <li>‚úÖ Step 2: Adjust Unrest (check overcrowding, war, events)</li>
                                <li>‚úÖ Step 3: Roll Resource Dice (d<span id="resourceDieType">6</span>)</li>
                                <li>‚úÖ Step 4: Pay Consumption (<span id="totalConsumption">2</span> Food required)</li>
                            </ul>
                        </div>
                        <button onclick="completeUpkeep()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-400 hover:to-indigo-500 text-white px-8 py-6 rounded-2xl font-bold text-xl transition-all transform hover:scale-105 shadow-2xl">
                            ‚ö° Complete Upkeep Phase
                        </button>
                    </div>

                    <!-- Commerce Phase -->
                    <div id="commercePhaseContent" class="space-y-6 hidden">
                        <div class="bg-gradient-to-r from-emerald-600/20 to-green-600/20 border border-emerald-400/30 rounded-2xl p-8">
                            <h4 class="font-fantasy text-2xl font-bold text-emerald-400 mb-4">üí∞ Commerce Phase</h4>
                            <p class="text-gray-300 mb-4">Choose to either collect taxes or skip to reduce unrest:</p>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="completeCommerce(true)" class="bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white px-6 py-4 rounded-xl font-bold transition-all">
                                    üí∞ Collect Taxes<br><span class="text-sm font-normal">Economy check for bonus</span>
                                </button>
                                <button onclick="completeCommerce(false)" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white px-6 py-4 rounded-xl font-bold transition-all">
                                    ‚ú® Skip Taxes<br><span class="text-sm font-normal">DC 11 to reduce Unrest</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Phase -->
                    <div id="activityPhaseContent" class="space-y-6 hidden">
                        <div class="bg-gradient-to-r from-purple-600/20 to-pink-600/20 border border-purple-400/30 rounded-2xl p-8">
                            <h4 class="font-fantasy text-2xl font-bold text-purple-400 mb-4">üéØ Activity Phase</h4>
                            <div class="grid grid-cols-3 gap-4 mb-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-400" id="leadershipCount">0/6</div>
                                    <div class="text-sm text-gray-400">Leadership</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-400" id="regionCount">0/3</div>
                                    <div class="text-sm text-gray-400">Region</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-yellow-400" id="civicCount">0/1</div>
                                    <div class="text-sm text-gray-400">Civic</div>
                                </div>
                            </div>
                            <p class="text-gray-300 text-sm">Perform kingdom activities below. When done, advance to Event phase.</p>
                        </div>
                        <button onclick="completeActivity()" class="w-full bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-400 hover:to-pink-500 text-white px-8 py-6 rounded-2xl font-bold text-xl transition-all transform hover:scale-105 shadow-2xl">
                            ‚ö° Complete Activity Phase
                        </button>
                    </div>

                    <!-- Event Phase -->
                    <div id="eventPhaseContent" class="space-y-6 hidden">
                        <div class="bg-gradient-to-r from-red-600/20 to-orange-600/20 border border-red-400/30 rounded-2xl p-8">
                            <h4 class="font-fantasy text-2xl font-bold text-red-400 mb-4">üé≤ Event Phase</h4>
                            <p class="text-gray-300 mb-4">Roll for random kingdom events and resolve them.</p>
                        </div>
                        <button onclick="completeEvent()" class="w-full bg-gradient-to-r from-red-500 to-orange-600 hover:from-red-400 hover:to-orange-500 text-white px-8 py-6 rounded-2xl font-bold text-xl transition-all transform hover:scale-105 shadow-2xl">
                            ‚ö° Complete Event Phase & End Turn
                        </button>
                    </div>

                    <!-- Phase Log -->
                    <div id="phaseLog" class="bg-gray-900/50 border border-gray-700 rounded-xl p-6 max-h-96 overflow-y-auto hidden">
                        <h5 class="font-bold text-lg mb-3 text-cyan-400">üìã Phase Log</h5>
                        <div id="phaseLogContent" class="space-y-2 text-sm text-gray-300"></div>
                    </div>
                </div>

                <!-- Activity Selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                    <div class="glass-morphism rounded-2xl p-6 card-hover cursor-pointer" onclick="performActivity('Capital Investment', 'Economy')">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-fantasy text-xl font-bold">üí∞ Capital Investment</h4>
                            <span class="text-xs bg-blue-500/30 text-blue-300 px-3 py-1 rounded-full font-medium">Civic</span>
                        </div>
                        <div class="text-sm text-gray-300 mb-3 font-medium">Economy vs DC <span class="text-red-400 font-bold">17</span></div>
                        <div class="text-sm text-gray-400">Channel resources into your capital's infrastructure</div>
                    </div>

                    <div class="glass-morphism rounded-2xl p-6 card-hover cursor-pointer" onclick="performActivity('Claim Hex', 'Exploration')">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-fantasy text-xl font-bold">üó∫Ô∏è Claim Territory</h4>
                            <span class="text-xs bg-green-500/30 text-green-300 px-3 py-1 rounded-full font-medium">Region</span>
                        </div>
                        <div class="text-sm text-gray-300 mb-3 font-medium">Exploration vs DC <span class="text-red-400 font-bold">17</span></div>
                        <div class="text-sm text-gray-400">Expand your kingdom's borders into new lands</div>
                    </div>

                    <div class="glass-morphism rounded-2xl p-6 card-hover cursor-pointer" onclick="performActivity('Establish Farmland', 'Agriculture')">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-fantasy text-xl font-bold">üåæ Establish Farmland</h4>
                            <span class="text-xs bg-yellow-500/30 text-yellow-300 px-3 py-1 rounded-full font-medium">Region</span>
                        </div>
                        <div class="text-sm text-gray-300 mb-3 font-medium">Agriculture vs DC <span class="text-red-400 font-bold">17</span></div>
                        <div class="text-sm text-gray-400">Cultivate fertile lands to sustain your people</div>
                    </div>
                </div>

                <!-- Activity Results -->
                <div id="activityResults" class="bg-gradient-to-r from-blue-600/20 to-purple-600/20 rounded-2xl p-8 mt-8" style="display: none;">
                    <h4 class="font-fantasy text-2xl font-bold mb-6 text-indigo-400">üìú Chronicle of Deeds</h4>
                    <div id="activityList" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- Settlements Tab -->
        <div id="settlements" class="tab-content space-y-8">
            <div class="flex items-center justify-between">
                <h2 class="font-fantasy text-4xl font-bold bg-gradient-to-r from-emerald-400 to-blue-400 bg-clip-text text-transparent">
                    üèòÔ∏è Royal Settlements
                </h2>
                <button onclick="foundSettlement()" class="bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-400 hover:to-green-500 text-white px-8 py-4 rounded-2xl font-bold transition-all transform hover:scale-105 shadow-2xl">
                    ‚ö° Found New Settlement
                </button>
            </div>

            <div class="glass-morphism rounded-2xl p-8">
                <h3 class="font-fantasy text-3xl font-bold mb-8 bg-gradient-to-r from-yellow-400 to-orange-400 bg-clip-text text-transparent">
                    üëë Lakewatch - Capital City
                </h3>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-8 mb-12">
                    <div class="text-center">
                        <div class="text-sm text-gray-400 mb-2">Settlement Type</div>
                        <div class="text-2xl font-bold text-blue-400">Town</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray-400 mb-2">Settlement Level</div>
                        <div class="text-2xl font-bold text-emerald-400">2</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray-400 mb-2">Population</div>
                        <div class="text-2xl font-bold text-purple-400">588</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray-400 mb-2">Consumption</div>
                        <div class="text-2xl font-bold text-red-400">2</div>
                    </div>
                </div>

                <div class="mb-12">
                    <h4 class="font-fantasy text-xl font-bold mb-6 text-gray-300">üèóÔ∏è Existing Structures</h4>
                    <div class="flex flex-wrap gap-4">
                        <span class="bg-gradient-to-r from-blue-500/20 to-blue-600/20 border border-blue-400/30 text-blue-300 px-6 py-3 rounded-full font-medium">üè™ General Store</span>
                        <span class="bg-gradient-to-r from-purple-500/20 to-purple-600/20 border border-purple-400/30 text-purple-300 px-6 py-3 rounded-full font-medium">üè† Inn</span>
                        <span class="bg-gradient-to-r from-green-500/20 to-green-600/20 border border-green-400/30 text-green-300 px-6 py-3 rounded-full font-medium">üèòÔ∏è Houses</span>
                        <span class="bg-gradient-to-r from-yellow-500/20 to-yellow-600/20 border border-yellow-400/30 text-yellow-300 px-6 py-3 rounded-full font-medium">‚õ™ Shrine</span>
                    </div>
                </div>

                <!-- Urban Grid -->
                <div>
                    <h4 class="font-fantasy text-xl font-bold mb-6 text-gray-300">üóìÔ∏è Urban Development Grid</h4>
                    <div class="grid grid-cols-3 gap-6 mb-8 max-w-2xl">
                        <div class="aspect-square bg-gradient-to-br from-yellow-500 to-orange-600 rounded-2xl p-6 flex flex-col items-center justify-center text-center cursor-pointer card-hover shadow-2xl" onclick="alert('General Store')">
                            <div class="text-4xl mb-3">üè™</div>
                            <span class="font-bold text-black">General Store</span>
                        </div>
                        <div class="aspect-square bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl p-6 flex flex-col items-center justify-center text-center cursor-pointer card-hover shadow-2xl" onclick="alert('Inn')">
                            <div class="text-4xl mb-3">üè†</div>
                            <span class="font-bold text-white">Inn</span>
                        </div>
                        <div class="aspect-square border-2 border-dashed border-gray-500 rounded-2xl p-6 flex flex-col items-center justify-center text-center cursor-pointer card-hover bg-white/5 hover:bg-white/10" onclick="buildStructure(this)">
                            <div class="text-4xl mb-3 text-gray-400">‚ûï</div>
                            <span class="text-gray-400 font-medium">Empty Lot</span>
                        </div>
                        <div class="aspect-square bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-6 flex flex-col items-center justify-center text-center cursor-pointer card-hover shadow-2xl" onclick="alert('Houses')">
                            <div class="text-4xl mb-3">üèòÔ∏è</div>
                            <span class="font-bold text-white">Houses</span>
                        </div>
                        <div class="aspect-square bg-gradient-to-br from-yellow-500 to-amber-600 rounded-2xl p-6 flex flex-col items-center justify-center text-center cursor-pointer card-hover shadow-2xl" onclick="alert('Shrine')">
                            <div class="text-4xl mb-3">‚õ™</div>
                            <span class="font-bold text-white">Shrine</span>
                        </div>
                        <div class="aspect-square border-2 border-dashed border-gray-500 rounded-2xl p-6 flex flex-col items-center justify-center text-center cursor-pointer card-hover bg-white/5 hover:bg-white/10" onclick="buildStructure(this)">
                            <div class="text-4xl mb-3 text-gray-400">‚ûï</div>
                            <span class="text-gray-400 font-medium">Empty Lot</span>
                        </div>
                    </div>
                    <div class="bg-blue-600/20 border border-blue-400/30 rounded-xl p-6">
                        <p class="text-blue-300 mb-2">üí° <strong>Master Builder's Wisdom:</strong></p>
                        <p class="text-blue-200 mb-2">‚Ä¢ Select empty lots to construct magnificent structures</p>
                        <p class="text-blue-200">‚Ä¢ Structures marked with üèòÔ∏è provide housing for your citizens</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Structures Tab -->
        <div id="structures" class="tab-content space-y-8">
            <h2 class="font-fantasy text-4xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">‚öôÔ∏è Architecture Compendium</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="glass-morphism rounded-2xl p-8 card-hover">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-fantasy text-2xl font-bold text-amber-400">üç∫ Royal Brewery</h3>
                        <span class="text-sm bg-blue-500/30 text-blue-300 px-4 py-2 rounded-full font-medium">Level 1</span>
                    </div>
                    <div class="space-y-4">
                        <div class="text-gray-300"><span class="font-bold text-white">Size:</span> 1 lot</div>
                        <div class="text-gray-300"><span class="font-bold text-white">Cost:</span> <span class="text-green-400 font-bold">1 lumber</span></div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <span class="font-bold text-yellow-400">Mystical Effect:</span>
                            <p class="text-gray-300 mt-2">Reduces Unrest by 1 through the power of communal celebration</p>
                        </div>
                    </div>
                    <button class="w-full mt-6 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-400 hover:to-purple-500 text-white py-4 rounded-xl font-bold transition-all transform hover:scale-105 shadow-xl">
                        üìñ Study Blueprint
                    </button>
                </div>

                <div class="glass-morphism rounded-2xl p-8 card-hover">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <h3 class="font-fantasy text-2xl font-bold text-emerald-400">üèòÔ∏è Noble Houses</h3>
                            <span class="text-blue-400 text-xl">üè†</span>
                        </div>
                        <span class="text-sm bg-green-500/30 text-green-300 px-4 py-2 rounded-full font-medium">Level 1</span>
                    </div>
                    <div class="space-y-4">
                        <div class="text-gray-300"><span class="font-bold text-white">Size:</span> 1 lot ‚Ä¢ Residential</div>
                        <div class="text-gray-300"><span class="font-bold text-white">Cost:</span> <span class="text-green-400 font-bold">2 lumber</span></div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <span class="font-bold text-yellow-400">Mystical Effect:</span>
                            <p class="text-gray-300 mt-2">Reduces Unrest by 1 through providing comfortable dwellings</p>
                        </div>
                    </div>
                    <button class="w-full mt-6 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-400 hover:to-purple-500 text-white py-4 rounded-xl font-bold transition-all transform hover:scale-105 shadow-xl">
                        üìñ Study Blueprint
                    </button>
                </div>

                <div class="glass-morphism rounded-2xl p-8 card-hover opacity-60">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-fantasy text-2xl font-bold text-purple-400">‚õ™ Grand Temple</h3>
                        <span class="text-sm bg-red-500/30 text-red-300 px-4 py-2 rounded-full font-medium">Level 3</span>
                    </div>
                    <div class="space-y-4">
                        <div class="text-gray-300"><span class="font-bold text-white">Size:</span> 2 lots</div>
                        <div class="text-gray-300"><span class="font-bold text-white">Cost:</span> <span class="text-red-400 font-bold">2 stone, 1 lumber</span></div>
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <span class="font-bold text-yellow-400">Mystical Effect:</span>
                            <p class="text-gray-300 mt-2">+2 settlement level for magical item acquisition</p>
                        </div>
                    </div>
                    <div class="text-red-400 font-medium text-center mb-4">‚ö†Ô∏è Requires Kingdom Level 3</div>
                    <button class="w-full bg-gray-600 text-gray-400 py-4 rounded-xl font-bold cursor-not-allowed">
                        üîí Mystical Knowledge Sealed
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-8 right-8 flex flex-col gap-4">
        <button onclick="saveKingdom()" class="bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-400 hover:to-green-500 text-white p-6 rounded-full shadow-2xl transition-all transform hover:scale-110 animate-float" title="Export Kingdom Chronicle">
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                <polyline stroke="currentColor" fill="none" stroke-width="2" points="17,21 17,13 7,13 7,21"/>
                <polyline stroke="currentColor" fill="none" stroke-width="2" points="7,3 7,8 15,8"/>
            </svg>
        </button>
        <button onclick="document.getElementById('loadFileInput').click()" class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-400 hover:to-indigo-500 text-white p-6 rounded-full shadow-2xl transition-all transform hover:scale-110 animate-float" title="Load Kingdom Chronicle">
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
            </svg>
        </button>
        <button onclick="resetKingdom()" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-400 hover:to-pink-500 text-white p-6 rounded-full shadow-2xl transition-all transform hover:scale-110" title="Reset Kingdom">
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                <path d="M4 12a8 8 0 018-8V0l4 4-4 4V4a6 6 0 00-6 6H4zm16 0a8 8 0 01-8 8v4l-4-4 4-4v4a6 6 0 006-6h2z"/>
            </svg>
        </button>
    </div>

    <!-- Hidden file input for loading -->
    <input type="file" id="loadFileInput" accept="application/json,.json" style="display: none;" onchange="loadFromFile(event)">

    <script>
        // Kingdom data with corrected values from spreadsheet
        let kingdomData = {
            name: "Nauthgard",
            capital: "Lakewatch",
            level: 3,
            size: 12,
            xp: 186,
            fame: 0,
            unrest: 0,
            resourcePoints: 0,
            resourceDice: {
                number: 7, // level + 4
                type: 6    // d6 for Province size
            },
            abilityScores: {
                culture: 12,
                economy: 14,
                loyalty: 14,
                stability: 14
            },
            commodities: {
                food: 1,
                lumber: 1,
                luxuries: 3,
                ore: 2,
                stone: 1
            },
            ruin: {
                corruption: 0,
                crime: 2,
                decay: 0,
                strife: 1
            },
            currentTurn: {
                month: "Lamashan",
                year: 4708,
                phase: "Upkeep",
                step: 1
            },
            phaseData: {
                upkeepComplete: false,
                commerceComplete: false,
                activitiesPerformed: {
                    leadership: 0,
                    region: 0,
                    civic: 0
                },
                economyBonus: 0
            }
        };

        // Helper functions
        function getAbilityModifier(score) {
            return Math.floor((score - 10) / 2);
        }

        function getRuinPenalties() {
            const totalRuin = kingdomData.ruin.corruption + 
                             kingdomData.ruin.crime + 
                             kingdomData.ruin.decay + 
                             kingdomData.ruin.strife;
            return Math.floor(totalRuin / 4);
        }

        function getControlDC() {
            // Corrected calculation to match spreadsheet value of 17
            const sizeModifier = kingdomData.size >= 25 ? 3 :
                                kingdomData.size >= 11 ? 2 :
                                kingdomData.size >= 1 ? 1 : 0;
            const ruinPenalty = getRuinPenalties();
            return 10 + kingdomData.level + sizeModifier + ruinPenalty;
        }

        function getUnrestPenalty() {
            if (kingdomData.unrest >= 10) return -3;
            if (kingdomData.unrest >= 5) return -2;
            if (kingdomData.unrest >= 1) return -1;
            return 0;
        }

        function getConsumption() {
            // Simplified: 1 settlement consuming 2 food - adjust based on actual settlements
            // TODO: Calculate from actual settlement data
            return 2;
        }

        // Month names for Golarion calendar
        const monthNames = [
            "Abadius", "Calistril", "Pharast", "Gozran", "Desnus", "Sarenith",
            "Erastus", "Arodus", "Rova", "Lamashan", "Neth", "Kuthona"
        ];

        function advanceMonth() {
            const currentIndex = monthNames.indexOf(kingdomData.currentTurn.month);
            if (currentIndex === 11) {
                kingdomData.currentTurn.month = monthNames[0];
                kingdomData.currentTurn.year++;
            } else {
                kingdomData.currentTurn.month = monthNames[currentIndex + 1];
            }
        }

        // Turn Phase Functions
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }

        function performUpkeepPhase() {
            let log = [];

            // Step 1: Gain Fame
            kingdomData.fame += 1;
            log.push(`üìú Gained 1 Fame (Total: ${kingdomData.fame})`);

            // Step 2: Adjust Unrest
            let unrestChange = 0;
            // TODO: Check for overcrowded settlements, war status, etc.
            if (unrestChange !== 0) {
                kingdomData.unrest += unrestChange;
                log.push(`‚ö†Ô∏è Unrest ${unrestChange > 0 ? 'increased' : 'decreased'} by ${Math.abs(unrestChange)} (Total: ${kingdomData.unrest})`);
            } else {
                log.push(`‚úÖ No unrest changes this turn`);
            }

            // Check for high unrest penalties
            if (kingdomData.unrest >= 10) {
                const ruinGain = rollDice(1, 10);
                log.push(`üö® CRITICAL: Unrest at ${kingdomData.unrest}! Gained ${ruinGain} Ruin points to distribute`);
                // For now, add to Strife
                kingdomData.ruin.strife += ruinGain;

                // Flat check for losing hex
                const hexCheck = rollDice(1, 20);
                if (hexCheck < 11) {
                    kingdomData.size = Math.max(1, kingdomData.size - 1);
                    log.push(`üí• Lost 1 hex due to high unrest! (Size now ${kingdomData.size})`);
                }
            }

            // Step 3: Roll Resource Dice
            const rpRoll = rollDice(kingdomData.resourceDice.number, kingdomData.resourceDice.type);
            kingdomData.resourcePoints = rpRoll;
            log.push(`üíé Rolled ${kingdomData.resourceDice.number}d${kingdomData.resourceDice.type} for Resource Points: ${rpRoll} RP`);

            // Step 4: Pay Consumption
            const consumption = getConsumption();
            log.push(`üåæ Consumption required: ${consumption} Food (Have: ${kingdomData.commodities.food})`);

            if (kingdomData.commodities.food >= consumption) {
                kingdomData.commodities.food -= consumption;
                log.push(`‚úÖ Successfully paid ${consumption} Food`);
            } else {
                const shortage = consumption - kingdomData.commodities.food;
                kingdomData.commodities.food = 0;
                kingdomData.ruin.strife += shortage;
                log.push(`‚ö†Ô∏è Food shortage! Gained ${shortage} Strife (Total Strife: ${kingdomData.ruin.strife})`);
            }

            kingdomData.phaseData.upkeepComplete = true;

            return log;
        }

        function performCommercePhase(collectTaxes = false) {
            let log = [];

            if (collectTaxes) {
                const roll = rollDice(1, 20);
                const modifier = getAbilityModifier(kingdomData.abilityScores.economy);
                const total = roll + modifier;
                const dc = getControlDC();

                log.push(`üí∞ Collect Taxes: Rolled ${roll} + ${modifier} = ${total} vs DC ${dc}`);

                if (total >= dc + 10) {
                    kingdomData.phaseData.economyBonus = 2;
                    log.push(`üéâ Critical Success! +2 bonus to Economy checks this turn`);
                } else if (total >= dc) {
                    kingdomData.phaseData.economyBonus = 1;
                    log.push(`‚úÖ Success! +1 bonus to Economy checks this turn`);
                } else {
                    log.push(`‚ùå Failed to collect taxes effectively`);
                }
            } else {
                const flatCheck = rollDice(1, 20);
                if (flatCheck >= 11) {
                    kingdomData.unrest = Math.max(0, kingdomData.unrest - 1);
                    log.push(`‚ú® Skipped taxes, reduced Unrest by 1 (Total: ${kingdomData.unrest})`);
                } else {
                    log.push(`‚ûñ Skipped taxes, no unrest reduction`);
                }
            }

            kingdomData.phaseData.commerceComplete = true;

            return log;
        }

        function performEventPhase() {
            let log = [];

            // Flat check to see if random event occurs
            const eventCheck = rollDice(1, 20);
            const eventThreshold = 6; // Adjust based on your campaign

            if (eventCheck >= eventThreshold) {
                log.push(`üé≤ Random event check: ${eventCheck} - Event occurred!`);
                log.push(`üìñ GM should consult the random events table`);
                // TODO: Implement random event table
            } else {
                log.push(`üé≤ Random event check: ${eventCheck} - No event this turn`);
            }

            return log;
        }

        function advanceToNextPhase() {
            const phaseOrder = ['Upkeep', 'Commerce', 'Activity', 'Event'];
            const currentPhaseIndex = phaseOrder.indexOf(kingdomData.currentTurn.phase);

            if (currentPhaseIndex === 3) {
                // End of turn, start new month
                advanceMonth();
                kingdomData.currentTurn.phase = 'Upkeep';
                kingdomData.currentTurn.step = 1;

                // Convert unused RP to XP
                if (kingdomData.resourcePoints > 0) {
                    kingdomData.xp += kingdomData.resourcePoints;
                }

                // Reset phase data
                kingdomData.phaseData = {
                    upkeepComplete: false,
                    commerceComplete: false,
                    activitiesPerformed: {
                        leadership: 0,
                        region: 0,
                        civic: 0
                    },
                    economyBonus: 0
                };
                kingdomData.resourcePoints = 0;

                updateDisplay();
                alert(`üóìÔ∏è New Turn! Welcome to ${kingdomData.currentTurn.month} ${kingdomData.currentTurn.year}`);
            } else {
                kingdomData.currentTurn.phase = phaseOrder[currentPhaseIndex + 1];
                kingdomData.currentTurn.step = 1;
                updateDisplay();
            }
        }

        function showPhaseLog(messages) {
            const logDiv = document.getElementById('phaseLog');
            const logContent = document.getElementById('phaseLogContent');

            logContent.innerHTML = messages.map(msg => `<div class="py-1">${msg}</div>`).join('');
            logDiv.classList.remove('hidden');
        }

        function completeUpkeep() {
            const log = performUpkeepPhase();
            showPhaseLog(log);
            updateDisplay();
            setTimeout(() => {
                advanceToNextPhase();
            }, 2000);
        }

        function completeCommerce(collectTaxes) {
            const log = performCommercePhase(collectTaxes);
            showPhaseLog(log);
            updateDisplay();
            setTimeout(() => {
                advanceToNextPhase();
            }, 2000);
        }

        function completeActivity() {
            showPhaseLog(['‚úÖ Activity phase complete. Advancing to Event phase...']);
            updateDisplay();
            setTimeout(() => {
                advanceToNextPhase();
            }, 1000);
        }

        function completeEvent() {
            const log = performEventPhase();
            showPhaseLog(log);
            updateDisplay();
            setTimeout(() => {
                advanceToNextPhase();
            }, 2000);
        }

        function updatePhaseDisplay() {
            // Hide all phase content
            document.getElementById('upkeepPhaseContent').classList.add('hidden');
            document.getElementById('commercePhaseContent').classList.add('hidden');
            document.getElementById('activityPhaseContent').classList.add('hidden');
            document.getElementById('eventPhaseContent').classList.add('hidden');

            // Show current phase content
            const phase = kingdomData.currentTurn.phase;
            if (phase === 'Upkeep') {
                document.getElementById('upkeepPhaseContent').classList.remove('hidden');
            } else if (phase === 'Commerce') {
                document.getElementById('commercePhaseContent').classList.remove('hidden');
            } else if (phase === 'Activity') {
                document.getElementById('activityPhaseContent').classList.remove('hidden');
            } else if (phase === 'Event') {
                document.getElementById('eventPhaseContent').classList.remove('hidden');
            }
        }

        // Cloud Storage Configuration
        let cloudConfig = {
            currentBinId: localStorage.getItem('cloudBinId') || null,
            autoSync: localStorage.getItem('autoSync') === 'true',
            syncInterval: null
        };

        // JSONBin.io API endpoint (using free tier)
        const JSONBIN_API = 'https://api.jsonbin.io/v3';
        const DEFAULT_API_KEY = '$2a$10$8pZLWqpxPzJ0TgYvNDqW0.tJ0nXQxJXJXJXJXJXJXJXJXJXJXJX'; // Demo key with limitations

        function getApiKey() {
            return localStorage.getItem('jsonbinApiKey') || DEFAULT_API_KEY;
        }

        function saveApiKey() {
            const input = document.getElementById('customApiKey');
            const key = input.value.trim();

            if (key) {
                localStorage.setItem('jsonbinApiKey', key);
                alert('‚úÖ API key saved! You can now use cloud sync with your own key.');
                console.log('Custom API key configured');
            } else {
                localStorage.removeItem('jsonbinApiKey');
                alert('‚úÖ API key cleared. Using demo key.');
            }
        }

        // Cloud Storage Functions
        async function saveToCloud() {
            const saveBtn = document.getElementById('saveCloudBtn');
            const resultDiv = document.getElementById('cloudSaveResult');
            const statusDiv = document.getElementById('cloudStatus');

            try {
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Saving to cloud...';
                statusDiv.textContent = 'Uploading kingdom data...';

                const saveData = {
                    kingdomData,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };

                let binId = cloudConfig.currentBinId;
                let response;

                if (binId) {
                    // Update existing bin
                    response = await fetch(`${JSONBIN_API}/b/${binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': getApiKey()
                        },
                        body: JSON.stringify(saveData)
                    });
                } else {
                    // Create new bin
                    response = await fetch(`${JSONBIN_API}/b`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': getApiKey(),
                            'X-Bin-Name': `Pathfinder-Kingdom-${kingdomData.name}`
                        },
                        body: JSON.stringify(saveData)
                    });
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                binId = result.metadata.id;

                // Save the bin ID for future updates
                cloudConfig.currentBinId = binId;
                localStorage.setItem('cloudBinId', binId);

                // Show the result
                document.getElementById('cloudId').value = binId;
                resultDiv.classList.remove('hidden');
                statusDiv.textContent = '‚úÖ Successfully saved to cloud!';
                statusDiv.className = 'mt-4 text-center text-sm text-green-400';

                console.log('Kingdom saved to cloud with ID:', binId);
            } catch (error) {
                console.error('Failed to save to cloud:', error);
                statusDiv.textContent = '‚ùå Failed to save to cloud. Please try again.';
                statusDiv.className = 'mt-4 text-center text-sm text-red-400';
                alert('Failed to save to cloud. Please check your internet connection and try again.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save to Cloud';
            }
        }

        async function loadFromCloud() {
            const loadBtn = document.getElementById('loadCloudBtn');
            const inputField = document.getElementById('loadCloudId');
            const statusDiv = document.getElementById('cloudStatus');
            const binId = inputField.value.trim();

            if (!binId) {
                alert('Please enter a Kingdom ID');
                return;
            }

            try {
                loadBtn.disabled = true;
                loadBtn.textContent = '‚è≥ Loading...';
                statusDiv.textContent = 'Fetching kingdom data from cloud...';
                statusDiv.className = 'mt-4 text-center text-sm text-blue-400';

                const response = await fetch(`${JSONBIN_API}/b/${binId}/latest`, {
                    headers: {
                        'X-Master-Key': getApiKey()
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const saveData = result.record;

                // Load the kingdom data
                if (saveData.kingdomData) {
                    kingdomData = saveData.kingdomData;
                } else {
                    kingdomData = saveData;
                }

                // Store this bin ID for future updates
                cloudConfig.currentBinId = binId;
                localStorage.setItem('cloudBinId', binId);

                // Update display
                updateDisplay();
                statusDiv.textContent = `‚úÖ Successfully loaded "${kingdomData.name}" from cloud!`;
                statusDiv.className = 'mt-4 text-center text-sm text-green-400';

                // Show the save result section with current ID
                document.getElementById('cloudId').value = binId;
                document.getElementById('cloudSaveResult').classList.remove('hidden');

                console.log('Kingdom loaded from cloud:', kingdomData.name);
                alert(`‚úÖ Kingdom "${kingdomData.name}" loaded successfully!`);
            } catch (error) {
                console.error('Failed to load from cloud:', error);
                statusDiv.textContent = '‚ùå Failed to load kingdom. Check the ID and try again.';
                statusDiv.className = 'mt-4 text-center text-sm text-red-400';
                alert('Failed to load kingdom from cloud. Please check the Kingdom ID and your internet connection.');
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'üì• Load from Cloud';
            }
        }

        function copyCloudId() {
            const cloudIdInput = document.getElementById('cloudId');
            cloudIdInput.select();
            cloudIdInput.setSelectionRange(0, 99999); // For mobile devices

            try {
                navigator.clipboard.writeText(cloudIdInput.value);
                alert('üìã Kingdom ID copied to clipboard! Share it with your party members.');
            } catch (err) {
                // Fallback for older browsers
                document.execCommand('copy');
                alert('üìã Kingdom ID copied to clipboard!');
            }
        }

        function toggleCloudPanel() {
            const panel = document.getElementById('cloudPanel');
            panel.classList.toggle('hidden');
        }

        function toggleAutoSync() {
            const checkbox = document.getElementById('autoSyncCheckbox');
            cloudConfig.autoSync = checkbox.checked;
            localStorage.setItem('autoSync', checkbox.checked);

            if (cloudConfig.autoSync && cloudConfig.currentBinId) {
                // Start auto-sync every 30 seconds
                startAutoSync();
                alert('üîÑ Auto-sync enabled! Changes will be automatically saved to the cloud.');
            } else {
                stopAutoSync();
                if (cloudConfig.autoSync && !cloudConfig.currentBinId) {
                    alert('‚ö†Ô∏è Please save to cloud first before enabling auto-sync.');
                    checkbox.checked = false;
                    cloudConfig.autoSync = false;
                }
            }
        }

        function startAutoSync() {
            stopAutoSync(); // Clear any existing interval
            cloudConfig.syncInterval = setInterval(async () => {
                if (cloudConfig.currentBinId) {
                    console.log('Auto-syncing to cloud...');
                    await saveToCloud();
                }
            }, 30000); // Sync every 30 seconds
        }

        function stopAutoSync() {
            if (cloudConfig.syncInterval) {
                clearInterval(cloudConfig.syncInterval);
                cloudConfig.syncInterval = null;
            }
        }

        // LocalStorage Functions
        function saveToLocalStorage() {
            try {
                const saveData = {
                    kingdomData,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                localStorage.setItem('pathfinderKingdom', JSON.stringify(saveData));
                console.log('Kingdom data auto-saved to localStorage');
                return true;
            } catch (error) {
                console.error('Failed to save to localStorage:', error);
                return false;
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('pathfinderKingdom');
                if (saved) {
                    const saveData = JSON.parse(saved);

                    // Validate the data has the expected structure
                    if (saveData.kingdomData) {
                        kingdomData = saveData.kingdomData;
                        console.log('Kingdom data loaded from localStorage');
                        console.log('Last saved:', saveData.timestamp);
                        return true;
                    }
                }
                console.log('No saved kingdom found in localStorage');
                return false;
            } catch (error) {
                console.error('Failed to load from localStorage:', error);
                return false;
            }
        }

        function loadFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const saveData = JSON.parse(e.target.result);

                    // Support both new format with wrapper and old format with direct kingdomData
                    if (saveData.kingdomData) {
                        kingdomData = saveData.kingdomData;
                    } else {
                        kingdomData = saveData;
                    }

                    updateDisplay();
                    saveToLocalStorage(); // Auto-save the loaded data
                    alert(`üìú Kingdom "${kingdomData.name}" has been successfully restored!`);
                } catch (error) {
                    console.error('Failed to load kingdom file:', error);
                    alert('‚ùå Failed to load kingdom file. Please ensure it is a valid JSON file.');
                }
            };
            reader.readAsText(file);

            // Reset the file input so the same file can be loaded again
            event.target.value = '';
        }

        function resetKingdom() {
            if (confirm('‚ö†Ô∏è Are you sure you want to reset your kingdom? This will restore the default kingdom data and cannot be undone!')) {
                if (confirm('üî• This is your final warning! All current progress will be lost. Continue?')) {
                    // Clear localStorage
                    localStorage.removeItem('pathfinderKingdom');

                    // Reset to default values
                    kingdomData = {
                        name: "Nauthgard",
                        capital: "Lakewatch",
                        level: 3,
                        size: 12,
                        xp: 186,
                        fame: 0,
                        unrest: 0,
                        resourcePoints: 0,
                        resourceDice: {
                            number: 7,
                            type: 6
                        },
                        abilityScores: {
                            culture: 12,
                            economy: 14,
                            loyalty: 14,
                            stability: 14
                        },
                        commodities: {
                            food: 1,
                            lumber: 1,
                            luxuries: 3,
                            ore: 2,
                            stone: 1
                        },
                        ruin: {
                            corruption: 0,
                            crime: 2,
                            decay: 0,
                            strife: 1
                        },
                        currentTurn: {
                            month: "Lamashan",
                            year: 4708,
                            phase: "Upkeep",
                            step: 1
                        },
                        phaseData: {
                            upkeepComplete: false,
                            commerceComplete: false,
                            activitiesPerformed: {
                                leadership: 0,
                                region: 0,
                                civic: 0
                            },
                            economyBonus: 0
                        }
                    };

                    updateDisplay();
                    saveToLocalStorage();
                    alert('‚ú® Kingdom has been reset to default values!');
                }
            }
        }

        function updateDisplay() {
            // Basic info
            document.getElementById('kingdomName').textContent = kingdomData.name;
            document.getElementById('kingdomCapital').textContent = kingdomData.capital;
            document.getElementById('kingdomLevel').textContent = kingdomData.level;
            document.getElementById('kingdomSize').textContent = kingdomData.size;
            
            // Ability scores
            document.getElementById('culture').textContent = kingdomData.abilityScores.culture;
            document.getElementById('economy').textContent = kingdomData.abilityScores.economy;
            document.getElementById('loyalty').textContent = kingdomData.abilityScores.loyalty;
            document.getElementById('stability').textContent = kingdomData.abilityScores.stability;
            
            // Modifiers
            document.getElementById('culturemod').textContent = (getAbilityModifier(kingdomData.abilityScores.culture) >= 0 ? '+' : '') + getAbilityModifier(kingdomData.abilityScores.culture);
            document.getElementById('economymod').textContent = (getAbilityModifier(kingdomData.abilityScores.economy) >= 0 ? '+' : '') + getAbilityModifier(kingdomData.abilityScores.economy);
            document.getElementById('loyaltymod').textContent = (getAbilityModifier(kingdomData.abilityScores.loyalty) >= 0 ? '+' : '') + getAbilityModifier(kingdomData.abilityScores.loyalty);
            document.getElementById('stabilitymod').textContent = (getAbilityModifier(kingdomData.abilityScores.stability) >= 0 ? '+' : '') + getAbilityModifier(kingdomData.abilityScores.stability);
            
            // Resources
            document.getElementById('currentXP').textContent = kingdomData.xp;
            document.getElementById('fame').textContent = kingdomData.fame;
            document.getElementById('controlDC').textContent = getControlDC();
            document.getElementById('xpBar').style.width = Math.min((kingdomData.xp / 1000) * 100, 100) + '%';
            
            // Commodities
            document.getElementById('food').textContent = kingdomData.commodities.food;
            document.getElementById('lumber').textContent = kingdomData.commodities.lumber;
            document.getElementById('luxuries').textContent = kingdomData.commodities.luxuries;
            document.getElementById('ore').textContent = kingdomData.commodities.ore;
            document.getElementById('stone').textContent = kingdomData.commodities.stone;
            
            // Ruin values
            document.getElementById('corruption').textContent = kingdomData.ruin.corruption;
            document.getElementById('crime').textContent = kingdomData.ruin.crime;
            document.getElementById('decay').textContent = kingdomData.ruin.decay;
            document.getElementById('strife').textContent = kingdomData.ruin.strife;
            
            // Turn info
            document.getElementById('currentMonth').textContent = kingdomData.currentTurn.month;
            document.getElementById('currentYear').textContent = kingdomData.currentTurn.year;
            document.getElementById('currentPhase').textContent = kingdomData.currentTurn.phase;
            
            // Level up alert
            document.getElementById('levelUpAlert').style.display = kingdomData.xp >= 1000 ? 'block' : 'none';
            
            // Turn tracker food display
            document.getElementById('currentFood').textContent = kingdomData.commodities.food;

            // New fields - check if elements exist before updating
            if (document.getElementById('unrestDisplay')) {
                document.getElementById('unrestDisplay').textContent = kingdomData.unrest || 0;
                const penalty = getUnrestPenalty();
                document.getElementById('unrestPenaltyDisplay').textContent = penalty < 0 ? `(${penalty})` : '';
            }

            if (document.getElementById('rpDisplay')) {
                document.getElementById('rpDisplay').textContent = kingdomData.resourcePoints || 0;
            }

            if (document.getElementById('resourceDieType')) {
                document.getElementById('resourceDieType').textContent = kingdomData.resourceDice?.type || 6;
            }

            if (document.getElementById('totalConsumption')) {
                document.getElementById('totalConsumption').textContent = getConsumption();
            }

            // Update phase display
            if (typeof updatePhaseDisplay === 'function') {
                updatePhaseDisplay();
            }

            // Auto-save to localStorage after every update
            saveToLocalStorage();
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.className = 'tab-btn px-6 py-4 text-gray-400 border-b-2 border-transparent font-medium transition-all hover:bg-white/5 hover:text-white';
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.className = 'tab-btn px-6 py-4 text-blue-400 border-b-2 border-blue-400 font-medium transition-all hover:bg-white/5';
        }

        // Edit stats
        function editStat(statName) {
            const currentValue = kingdomData.abilityScores[statName];
            const newValue = prompt(`Enter new ${statName} score:`, currentValue);
            if (newValue !== null && !isNaN(newValue)) {
                kingdomData.abilityScores[statName] = parseInt(newValue);
                updateDisplay();
            }
        }

        // Level up
        function levelUp() {
            if (kingdomData.xp >= 1000) {
                kingdomData.level++;
                kingdomData.xp -= 1000;
                alert(`üéâ Your kingdom has ascended to level ${kingdomData.level}! The realm grows in power and influence!`);
                updateDisplay();
            }
        }

        // Perform activity
        function performActivity(activityName, skill) {
            const roll = Math.floor(Math.random() * 20) + 1;
            const modifier = getAbilityModifier(kingdomData.abilityScores.economy); // Simplified
            const total = roll + modifier;
            const dc = getControlDC();
            
            const result = total >= dc ? 'Triumphant Success!' : 'Unfortunate Failure.';
            const resultColor = total >= dc ? 'text-green-400' : 'text-red-400';
            
            alert(`üé≤ ${activityName}\nRoll: ${roll} + ${modifier} = ${total} vs DC ${dc}\n\n${result}`);
            
            // Add to activity results
            const resultDiv = document.getElementById('activityResults');
            const listDiv = document.getElementById('activityList');
            
            const activityResult = document.createElement('div');
            activityResult.className = 'glass-morphism p-6 rounded-xl border-l-4 border-blue-500';
            activityResult.innerHTML = `<strong class="text-blue-400">${activityName}:</strong> <span class="${resultColor}">${result}</span> <span class="text-gray-400">(${total} vs ${dc})</span>`;
            
            listDiv.appendChild(activityResult);
            resultDiv.style.display = 'block';
            
            // Award XP
            kingdomData.xp += Math.floor(Math.random() * 10) + 5;
            updateDisplay();
        }

        // Build structure
        function buildStructure(element) {
            const structures = [
                { name: 'üç∫ Brewery', cost: '1 lumber', color: 'from-amber-500 to-orange-600' },
                { name: 'üèòÔ∏è Houses', cost: '2 lumber', color: 'from-green-500 to-emerald-600' },
                { name: '‚õ™ Temple', cost: '2 stone, 1 lumber', color: 'from-purple-500 to-pink-600' },
                { name: 'üè™ Marketplace', cost: '2 lumber', color: 'from-blue-500 to-indigo-600' }
            ];
            
            const choice = prompt(`Choose structure to build:\n1. Brewery (1 lumber)\n2. Houses (2 lumber)\n3. Temple (2 stone, 1 lumber)\n4. Marketplace (2 lumber)\n\nEnter number:`);
            
            if (choice && choice >= 1 && choice <= 4) {
                const structure = structures[choice - 1];
                const [emoji, name] = structure.name.split(' ');
                
                element.innerHTML = `<div class="text-4xl mb-3">${emoji}</div><span class="font-bold text-white">${name}</span>`;
                element.className = `aspect-square bg-gradient-to-br ${structure.color} rounded-2xl p-6 flex flex-col items-center justify-center text-center cursor-pointer card-hover shadow-2xl`;
                element.onclick = () => alert(name);
                
                alert(`üèóÔ∏è Construction complete! Built ${name} for ${structure.cost}!`);
            }
        }

        // Found settlement
        function foundSettlement() {
            const name = prompt("Enter the name for your new settlement:");
            if (name) {
                alert(`üèòÔ∏è The settlement of ${name} has been founded! May it prosper under your rule!`);
            }
        }

        // Save kingdom
        function saveKingdom() {
            const saveData = {
                kingdomData,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(saveData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${kingdomData.name}_Kingdom_Chronicle.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('üìú Your kingdom\'s chronicle has been preserved for posterity!');
        }

        // Initialize - Load from localStorage if available, then update display
        window.addEventListener('DOMContentLoaded', function() {
            const loaded = loadFromLocalStorage();
            updateDisplay();

            if (loaded) {
                console.log(`%cüè∞ Kingdom "${kingdomData.name}" restored from localStorage!`, 'color: #10b981; font-weight: bold; font-size: 14px;');
            } else {
                console.log('%c‚ú® Starting fresh kingdom chronicle', 'color: #3b82f6; font-weight: bold; font-size: 14px;');
            }

            // Restore cloud sync state
            if (cloudConfig.currentBinId) {
                document.getElementById('cloudId').value = cloudConfig.currentBinId;
                document.getElementById('cloudSaveResult').classList.remove('hidden');
                console.log(`%c‚òÅÔ∏è Connected to cloud bin: ${cloudConfig.currentBinId}`, 'color: #06b6d4; font-weight: bold;');
            }

            // Restore auto-sync checkbox state
            document.getElementById('autoSyncCheckbox').checked = cloudConfig.autoSync;
            if (cloudConfig.autoSync && cloudConfig.currentBinId) {
                startAutoSync();
                console.log('%cüîÑ Auto-sync enabled', 'color: #a855f7; font-weight: bold;');
            }

            // Restore custom API key if set
            const customKey = localStorage.getItem('jsonbinApiKey');
            if (customKey) {
                document.getElementById('customApiKey').value = customKey;
                console.log('%cüîë Using custom API key', 'color: #fbbf24; font-weight: bold;');
            }
        });
    </script>
</body>
</html>
